name: Publish NPM package

on:
    push:
        branches:
            - main

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 17
                  registry-url: 'https://registry.npmjs.org'

            - name: Install dependencies
              run: npm ci

            - name: Test
              run: npm test

            - name: Check the version
              run: |
                  CURRENT_VERSION=$(npm view . version)
                  LOCAL_VERSION=$(node -p "require('./package.json').version")
                  if [ "$CURRENT_VERSION" = "$LOCAL_VERSION" ]; then
                    echo "Error: Version $LOCAL_VERSION is already published"
                    exit 1
                  fi
